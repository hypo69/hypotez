# Модуль `post_message_async`

## Обзор

Модуль `post_message_async` обеспечивает функциональность для публикации асинхронных сообщений в Facebook с использованием промо-материалов с AliExpress. Модуль использует веб-драйвер (WebDriver) для взаимодействия с веб-страницей Facebook и предоставляет функции для загрузки изображений/видео, добавления подписей к изображениям/видео и публикации сообщения.

## Подробнее

Модуль использует предопределенные локаторы для взаимодействия с элементами веб-страницы Facebook, которые определены в файле `post_message.json`. Модуль использует асинхронные операции для повышения производительности и оптимизации процесса публикации.

## Функции

### `post_title`

**Назначение**: Функция отправляет заголовок и описание кампании в поле сообщения.

**Параметры**:

- `d` (Driver): Экземпляр WebDriver для взаимодействия с веб-страницей.
- `category` (SimpleNamespace): Категория, содержащая заголовок и описание для отправки.

**Возвращает**:

- `bool`: `True`, если заголовок и описание были отправлены успешно, иначе `None`.

**Вызывает исключения**:

- None

**Как работает функция**:

1. Функция выполняет прокрутку страницы вверх.
2. Открывает поле добавления сообщения.
3. Формирует сообщение, объединяя заголовок и описание из `category`.
4. Отправляет сообщение в поле добавления сообщения.

**Примеры**:

```python
>>> driver = Driver(...)
>>> category = SimpleNamespace(title="Campaign Title", description="Campaign Description")
>>> post_title(driver, category)
True
```

### `upload_media`

**Назначение**: Функция загружает медиа-файлы (изображения/видео) в раздел "Изображения" и обновляет подписи к медиа.

**Параметры**:

- `d` (Driver): Экземпляр WebDriver для взаимодействия с веб-страницей.
- `products` (List[SimpleNamespace]): Список товаров, содержащий пути к медиа-файлам.
- `no_video` (bool, optional): Если установлено в `True`, то видео не будет загружено. По умолчанию `False`.

**Возвращает**:

- `bool`: `True`, если медиа-файлы были загружены успешно, иначе `None`.

**Вызывает исключения**:

- `Exception`: Если возникает ошибка во время загрузки медиа или обновления подписей.

**Как работает функция**:

1. Функция открывает форму добавления медиа.
2. Проверяет, является ли `products` списком.
3. В цикле итерирует по товарам и выполняет следующие действия для каждого товара:
    - Определяет путь к медиа-файлу (видео или изображение).
    - Загружает медиа-файл.
    - Обновляет подписи к медиа-файлу.
4. Возвращает `True`, если все медиа-файлы были загружены успешно, иначе `None`.

**Примеры**:

```python
>>> driver = Driver(...)
>>> products = [SimpleNamespace(local_image_path='path/to/image.jpg', ...)]
>>> await upload_media(driver, products)
True
```

### `update_images_captions`

**Назначение**: Функция добавляет описания к загруженным медиа-файлам асинхронно.

**Параметры**:

- `d` (Driver): Экземпляр WebDriver для взаимодействия с веб-страницей.
- `products` (List[SimpleNamespace]): Список товаров, содержащий информацию для обновления.
- `textarea_list` (List[WebElement]): Список текстовых областей, куда добавляются подписи.

**Возвращает**:

- `None`

**Вызывает исключения**:

- `Exception`: Если возникает ошибка при обновлении подписей к медиа.

**Как работает функция**:

1. Загружает данные о локалях из файла `translations.json`.
2. Внутри функции `handle_product` выполняет следующие действия:
    - Определяет направление текста (LTR или RTL).
    - Формирует сообщение, используя информацию о товаре и локаль.
    - Отправляет сформированное сообщение в текстовую область.
3. Асинхронно обрабатывает каждый товар с помощью `asyncio.to_thread` и выполняет функцию `handle_product` в отдельном потоке.

**Примеры**:

```python
>>> driver = Driver(...)
>>> products = [SimpleNamespace(local_image_path='path/to/image.jpg', ...)]
>>> textarea_list = d.execute_locator(locator.edit_image_properties_textarea)
>>> await update_images_captions(driver, products, textarea_list)
```

### `promote_post`

**Назначение**: Функция управляет процессом публикации поста с заголовком, описанием и медиа-файлами.

**Параметры**:

- `d` (Driver): Экземпляр WebDriver для взаимодействия с веб-страницей.
- `category` (SimpleNamespace): Детали категории, используемые для заголовка и описания поста.
- `products` (List[SimpleNamespace]): Список товаров, содержащий медиа и информацию для публикации.
- `no_video` (bool, optional): Если установлено в `True`, то видео не будет загружено. По умолчанию `False`.

**Возвращает**:

- `bool`: `True`, если пост был опубликован успешно, иначе `None`.

**Вызывает исключения**:

- None

**Как работает функция**:

1. Функция вызывает `post_title` для отправки заголовка и описания.
2. Вызывает `upload_media` для загрузки медиа-файлов.
3. Завершает редактирование поста.
4. Публикует пост.

**Примеры**:

```python
>>> driver = Driver(...)
>>> category = SimpleNamespace(title="Campaign Title", description="Campaign Description")
>>> products = [SimpleNamespace(local_image_path='path/to/image.jpg', ...)]
>>> await promote_post(driver, category, products)
```

## Внутренние функции

### `handle_product`

**Назначение**: Функция синхронно обрабатывает обновление подписей к медиа для одного товара.

**Параметры**:

- `product` (SimpleNamespace): товар, который нужно обновить.
- `textarea_list` (List[WebElement]): Список текстовых областей, куда добавляются подписи.
- `i` (int): Индекс товара в списке.

**Возвращает**:

- `None`

**Вызывает исключения**:

- `Exception`: Если возникает ошибка при генерации сообщения.

**Как работает функция**:

1. Определяет направление текста (LTR или RTL).
2. Формирует сообщение, используя информацию о товаре и локаль.
3. Отправляет сформированное сообщение в текстовую область.

**Примеры**:

```python
>>> product = SimpleNamespace(product_title="Product Title", ...)
>>> textarea_list = d.execute_locator(locator.edit_image_properties_textarea)
>>> handle_product(product, textarea_list, 0)
```