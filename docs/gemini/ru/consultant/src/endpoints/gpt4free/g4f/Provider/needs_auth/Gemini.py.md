### **–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `Gemini.py`**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ:** `hypotez/src/endpoints/gpt4free/g4f/Provider/needs_auth/Gemini.py`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∞—Å—Å `Gemini`, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –º–æ–¥–µ–ª—å—é Google Gemini. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ cookies –∏ –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
    - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cookies –∏ –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `nodriver` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- **–ú–∏–Ω—É—Å—ã**:
    - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ —Å–ª–æ–∂–Ω—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–∑-–∑–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫.
    - –ù–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ docstring.
    - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ –º–Ω–æ–≥–∏—Ö –º–µ—Å—Ç–∞—Ö.
    - –ù–µ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:**

1.  **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
    *   –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ docstring –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤, –≤–∫–ª—é—á–∞—è –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
    *   –£–ª—É—á—à–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∏—Ö –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–º–∏.
2.  **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
    *   –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `logger` –∏–∑ `src.logger` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.
3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**:
    *   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `logger.error` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫.
4.  **–¢–∏–ø–∏–∑–∞—Ü–∏—è**:
    *   –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π, –≥–¥–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
5.  **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥**:
    *   –†–∞–∑–±–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –±–æ–ª–µ–µ –º–µ–ª–∫–∏–µ, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É.
    *   –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç—Ä–æ–∫ –∏ JSON-–¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:**

```python
from __future__ import annotations

import os
import json
import random
import re
import base64
import asyncio
import time

from urllib.parse import quote_plus, unquote_plus
from pathlib import Path
from aiohttp import ClientSession, BaseConnector
from typing import Generator, Optional, List, AsyncIterator, Dict, Any, Tuple

from src.logger import logger  # Import logger
from ... import debug
from ...typing import Messages, Cookies, MediaListType, AsyncResult
from ...providers.response import JsonConversation, Reasoning, RequestLogin, ImageResponse, YouTube
from ...requests.raise_for_status import raise_for_status
from ...requests.aiohttp import get_connector
from ...requests import get_nodriver
from ...errors import MissingAuthError
from ...image import to_bytes
from ...cookies import get_cookies_dir
from ...tools.media import merge_media
from ..base_provider import AsyncGeneratorProvider, ProviderModelMixin

try:
    import nodriver
    has_nodriver = True
except ImportError:
    has_nodriver = False

REQUEST_HEADERS = {
    "authority": "gemini.google.com",
    "origin": "https://gemini.google.com",
    "referer": "https://gemini.google.com/",
    'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36',
    'x-same-domain': '1',
}
REQUEST_BL_PARAM = "boq_assistant-bard-web-server_20240519.16_p0"
REQUEST_URL = "https://gemini.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate"
UPLOAD_IMAGE_URL = "https://content-push.googleapis.com/upload/"
UPLOAD_IMAGE_HEADERS = {
    "authority": "content-push.googleapis.com",
    "accept": "*/*",
    "accept-language": "en-US,en;q=0.7",
    "authorization": "Basic c2F2ZXM6cyNMdGhlNmxzd2F2b0RsN3J1d1U=",
    "content-type": "application/x-www-form-urlencoded;charset=UTF-8",
    "origin": "https://gemini.google.com",
    "push-id": "feeds/mcudyrk2a4khkz",
    "referer": "https://gemini.google.com/",
    "x-goog-upload-command": "start",
    "x-goog-upload-header-content-length": "",
    "x-goog-upload-protocol": "resumable",
    "x-tenant-id": "bard-storage",
}
GOOGLE_COOKIE_DOMAIN = ".google.com"
ROTATE_COOKIES_URL = "https://accounts.google.com/RotateCookies"
GGOGLE_SID_COOKIE = "__Secure-1PSID"

models = {
    "gemini-2.0-flash": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"f299729663a2343f"]'},
    "gemini-2.0-flash-exp": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"f299729663a2343f"]'},
    "gemini-2.0-flash-thinking": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"9c17b1863f581b8a"]'},
    "gemini-2.0-flash-thinking-with-apps": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"f8f8f5ea629f5d37"]'},
    "gemini-2.0-exp-advanced": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"b1e46a6037e6aa9f"]'},
    "gemini-1.5-flash": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"418ab5ea040b5c43"]'},
    "gemini-1.5-pro": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"9d60dfae93c9ff1f"]'},
    "gemini-1.5-pro-research": {"x-goog-ext-525001261-jspb": '[null,null,null,null,"e5a44cb1dae2b489"]'},
}


class Gemini(AsyncGeneratorProvider, ProviderModelMixin):
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Google Gemini API.
    """
    label: str = "Google Gemini"
    url: str = "https://gemini.google.com"
    needs_auth: bool = True
    working: bool = True
    use_nodriver: bool = True
    default_model: str = ""
    default_image_model: str = default_model
    default_vision_model: str = default_model
    image_models: List[str] = [default_image_model]
    models: List[str] = [
        default_model, *models.keys()
    ]
    model_aliases: Dict[str, str] = {"gemini-2.0": ""}
    synthesize_content_type: str = "audio/vnd.wav"
    _cookies: Cookies = None
    _snlm0e: str = None
    _sid: str = None
    auto_refresh: bool = True
    refresh_interval: int = 540
    rotate_tasks: Dict[str, asyncio.Task] = {}

    @classmethod
    async def nodriver_login(cls, proxy: Optional[str] = None) -> AsyncIterator[str]:
        """
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Ö–æ–¥ –≤ Gemini —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º nodriver.

        Args:
            proxy (Optional[str]): –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

        Yields:
            AsyncIterator[str]: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—Ö–æ–¥–∞.

        Raises:
            ImportError: –ï—Å–ª–∏ –º–æ–¥—É–ª—å nodriver –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
            Exception: –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
        """
        if not has_nodriver:
            if debug.logging:
                print("Skip nodriver login in Gemini provider")
            return

        browser, stop_browser = await get_nodriver(proxy=proxy, user_data_dir="gemini")
        try:
            login_url = os.environ.get("G4F_LOGIN_URL")
            if login_url:
                yield RequestLogin(cls.label, login_url)
            page = await browser.get(f"{cls.url}/app")
            await page.select("div.ql-editor.textarea", 240)
            cookies: Dict[str, str] = {}
            for c in await page.send(nodriver.cdp.network.get_cookies([cls.url])):
                cookies[c.name] = c.value
            await page.close()
            cls._cookies = cookies
        except Exception as ex:
            logger.error('Error during nodriver login', ex, exc_info=True)  # Log the error
        finally:
            stop_browser()

    @classmethod
    async def start_auto_refresh(cls, proxy: str = None) -> None:
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è cookies.
        """
        while True:
            try:
                new_1psidts = await rotate_1psidts(cls.url, cls._cookies, proxy)
            except Exception as ex:
                logger.error(f"Failed to refresh cookies: {ex}", exc_info=True)  # Log the error
                task = cls.rotate_tasks.get(cls._cookies[GGOGLE_SID_COOKIE])
                if task:
                    task.cancel()
                logger.error(
                    "Failed to refresh cookies. Background auto refresh task canceled."
                )

            debug.log(f"Gemini: Cookies refreshed. New __Secure-1PSIDTS: {new_1psidts}")
            if new_1psidts:
                cls._cookies["__Secure-1PSIDTS"] = new_1psidts
            await asyncio.sleep(cls.refresh_interval)

    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: Optional[str] = None,
        cookies: Optional[Cookies] = None,
        connector: Optional[BaseConnector] = None,
        media: Optional[MediaListType] = None,
        return_conversation: bool = False,
        conversation: Optional[Conversation] = None,
        language: str = "en",
        **kwargs
    ) -> AsyncResult:
        """
        –°–æ–∑–¥–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Gemini.

        Args:
            model (str): –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
            messages (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
            proxy (Optional[str]): –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
            cookies (Optional[Cookies]): Cookies –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
            connector (Optional[BaseConnector]): –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –¥–ª—è aiohttp.
            media (Optional[MediaListType]): –°–ø–∏—Å–æ–∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
            return_conversation (bool): –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ.
            conversation (Optional[Conversation]): –û–±—ä–µ–∫—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
            language (str): –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞.

        Yields:
            AsyncIterator[str | Conversation | Reasoning | ImageResponse | YouTube]: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini.

        Raises:
            MissingAuthError: –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç cookie "__Secure-1PSID".
            RuntimeError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å SNlM0e.
            Exception: –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
        """
        cls._cookies = cookies or cls._cookies or get_cookies(GOOGLE_COOKIE_DOMAIN, False, True)
        if conversation is not None and getattr(conversation, "model", None) != model:
            conversation = None
        prompt = format_prompt(messages) if conversation is None else get_last_user_message(messages)
        base_connector = get_connector(connector, proxy)

        async with ClientSession(
            headers=REQUEST_HEADERS,
            connector=base_connector
        ) as session:
            if not cls._snlm0e:
                await cls.fetch_snlm0e(session, cls._cookies) if cls._cookies else None
            if not cls._snlm0e:
                try:
                    async for chunk in cls.nodriver_login(proxy):
                        yield chunk
                except Exception as ex:
                    raise MissingAuthError('Missing or invalid "__Secure-1PSID" cookie', ex)
            if not cls._snlm0e:
                if cls._cookies is None or "__Secure-1PSID" not in cls._cookies:
                    raise MissingAuthError('Missing "__Secure-1PSID" cookie')
                await cls.fetch_snlm0e(session, cls._cookies)
            if not cls._snlm0e:
                raise RuntimeError("Invalid cookies. SNlM0e not found")
            if GGOGLE_SID_COOKIE in cls._cookies:
                task = cls.rotate_tasks.get(cls._cookies[GGOGLE_SID_COOKIE])
                if not task:
                    cls.rotate_tasks[cls._cookies[GGOGLE_SID_COOKIE]] = asyncio.create_task(
                        cls.start_auto_refresh()
                    )

            uploads = await cls.upload_images(base_connector, merge_media(media, messages))
            async with ClientSession(
                cookies=cls._cookies,
                headers=REQUEST_HEADERS,
                connector=base_connector,
            ) as client:
                params = {
                    'bl': REQUEST_BL_PARAM,
                    'hl': language,
                    '_reqid': random.randint(1111, 9999),
                    'rt': 'c',
                    "f.sid": cls._sid,
                }
                data = {
                    'at': cls._snlm0e,
                    'f.req': json.dumps([None, json.dumps(cls.build_request(
                        prompt,
                        language=language,
                        conversation=conversation,
                        uploads=uploads
                    ))])
                }
                async with client.post(
                    REQUEST_URL,
                    data=data,
                    params=params,
                    headers=models[model] if model in models else None
                ) as response:
                    await raise_for_status(response)
                    image_prompt = response_part = None
                    last_content = ""
                    async for line in response.content:
                        try:
                            try:
                                line = json.loads(line)
                            except ValueError:
                                continue
                            if not isinstance(line, list):
                                continue
                            if len(line[0]) < 3 or not line[0][2]:
                                continue
                            response_part = json.loads(line[0][2])
                            if not response_part[4]:
                                continue
                            if return_conversation:
                                yield Conversation(response_part[1][0], response_part[1][1], response_part[4][0][0], model)
                            def read_recusive(data: list) -> Generator[Any, None, None]:
                                """
                                –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø–∏—Å–∫–∞.

                                Args:
                                    data (list): –°–ø–∏—Å–æ–∫ –¥–ª—è —á—Ç–µ–Ω–∏—è.

                                Yields:
                                    Any: –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞.
                                """
                                for item in data:
                                    if isinstance(item, list):
                                        yield from read_recusive(item)
                                    elif isinstance(item, str) and not item.startswith("rc_"):
                                        yield item
                            def find_str(data: list, skip: int = 0) -> Generator[str, None, None]:
                                """
                                –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–ø—É—Å–∫–∞—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

                                Args:
                                    data (list): –°–ø–∏—Å–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞.
                                    skip (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞.

                                Yields:
                                    str: –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.
                                """
                                for item in read_recusive(data):
                                    if skip > 0:
                                        skip -= 1
                                        continue
                                    yield item
                            reasoning = "\\n\\n".join(find_str(response_part[4][0], 3))
                            reasoning = re.sub(r"<b>|</b>", "**", reasoning)
                            def replace_image(match: re.Match) -> str:
                                """
                                –ó–∞–º–µ–Ω—è–µ—Ç URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–∫—Å—Ç–µ.

                                Args:
                                    match (re.Match): –û–±—ä–µ–∫—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.

                                Returns:
                                    str: URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.
                                """
                                return f"![](https:{match.group(0)})"
                            reasoning = re.sub(r"//yt3.(?:ggpht.com|googleusercontent.com/ytc)/[\\w=-]+", replace_image, reasoning)
                            reasoning = re.sub(r"\\nyoutube\\n", "\\n\\n\\n", reasoning)
                            reasoning = re.sub(r"\\nyoutube_tool\\n", "\\n\\n", reasoning)
                            reasoning = re.sub(r"\\nYouTube\\n", "\\nYouTube ", reasoning)
                            reasoning = reasoning.replace('\\nhttps://www.gstatic.com/images/branding/productlogos/youtube/v9/192px.svg', '<i class="fa-brands fa-youtube"></i>')
                            content = response_part[4][0][1][0]
                            if reasoning:
                                yield Reasoning(reasoning, status="ü§î")
                        except (ValueError, KeyError, TypeError, IndexError) as ex:
                            logger.error(f"{cls.__name__} {type(ex).__name__}: {ex}", exc_info=True)  # Log the error
                            continue
                        match = re.search(r'\\[Imagen of (.*?)\\]', content)
                        if match:
                            image_prompt = match.group(1)
                            content = content.replace(match.group(0), '')
                        pattern = r"http://googleusercontent.com/(?:image_generation|youtube|map)_content/\\d+"
                        content = re.sub(pattern, "", content)
                        content = content.replace("<!-- end list -->", "")
                        def replace_link(match: re.Match) -> str:
                            """
                            –ó–∞–º–µ–Ω—è–µ—Ç URL —Å—Å—ã–ª–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ.

                            Args:
                                match (re.Match): –û–±—ä–µ–∫—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.

                            Returns:
                                str: URL —Å—Å—ã–ª–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.
                            """
                            return f"(https://{quote_plus(unquote_plus(match.group(1)), '/?&=#')})"
                        content = re.sub(r"\\(https://www.google.com/(?:search\\?q=|url\\?sa=E&source=gmail&q=)https?://(.+?)\\)", replace_link, content)

                        if last_content and content.startswith(last_content):
                            yield content[len(last_content):]
                        else:
                            yield content
                        last_content = content
                        if image_prompt:
                            try:
                                images = [image[0][3][3] for image in response_part[4][0][12][7][0]]
                                image_prompt = image_prompt.replace("a fake image", "")
                                yield ImageResponse(images, image_prompt, {"cookies": cls._cookies})
                            except (TypeError, IndexError, KeyError) as ex:
                                logger.error(f"Error processing image response: {ex}", exc_info=True)  # Log the error
                                pass
                        youtube_ids = []
                        pattern = re.compile(r"http://www.youtube.com/watch\\?v=([\\w-]+)")
                        for match in pattern.finditer(content):
                            if match.group(1) not in youtube_ids:
                                youtube_ids.append(match.group(1))
                        if youtube_ids:
                            yield YouTube(youtube_ids)

    @classmethod
    async def synthesize(cls, params: dict, proxy: Optional[str] = None) -> AsyncIterator[bytes]:
        """
        –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç —Ä–µ—á—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

        Args:
            params (dict): –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞.
            proxy (Optional[str]): –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

        Yields:
            AsyncIterator[bytes]: –ê—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ bytes.

        Raises:
            ValueError: –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä "text".
            Exception: –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è —Å–∏–Ω—Ç–µ–∑–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
        """
        if "text" not in params:
            raise ValueError("Missing parameter text")
        async with ClientSession(
            cookies=cls._cookies,
            headers=REQUEST_HEADERS,
            connector=get_connector(proxy=proxy),
        ) as session:
            if not cls._snlm0e:
                await cls.fetch_snlm0e(session, cls._cookies) if cls._cookies else None
            inner_data = json.dumps([None, params["text"], "en-US", None, 2])
            async with session.post(
                "https://gemini.google.com/_/BardChatUi/data/batchexecute",
                data={
                      "f.req": json.dumps([[["XqA3Ic", inner_data, None, "generic"]]]),
                      "at": cls._snlm0e,
                },
                params={
                    "rpcids": "XqA3Ic",
                    "source-path": "/app/2704fb4aafcca926",
                    "bl": "boq_assistant-bard-web-server_20241119.00_p1",
                    "f.sid": "" if cls._sid is None else cls._sid,
                    "hl": "de",
                    "_reqid": random.randint(1111, 9999),
                    "rt": "c"
                },
            ) as response:
                await raise_for_status(response)
                iter_base64_response = iter_filter_base64(response.content.iter_chunked(1024))
                async for chunk in iter_base64_decode(iter_base64_response):
                    yield chunk

    def build_request(
        prompt: str,
        language: str,
        conversation: Optional[Conversation] = None,
        uploads: Optional[List[Tuple[str, str]]] = None,
        tools: List[List[str]] = []
    ) -> list:
        """
        –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Gemini API.

        Args:
            prompt (str): –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞.
            language (str): –Ø–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–∞.
            conversation (Optional[Conversation]): –û–±—ä–µ–∫—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
            uploads (Optional[List[Tuple[str, str]]]): –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
            tools (List[List[str]]): –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

        Returns:
            list: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å.
        """
        image_list = [[[image_url, 1], image_name] for image_url, image_name in uploads] if uploads else []
        return [
            [prompt, 0, None, image_list, None, None, 0],
            [language],
            [
                None if conversation is None else conversation.conversation_id,
                None if conversation is None else conversation.response_id,
                None if conversation is None else conversation.choice_id,
                None,
                None,
                []
            ],
            None,
            None,
            None,
            [1],
            0,
            [],
            tools,
            1,
            0,
        ]

    async def upload_images(connector: BaseConnector, media: MediaListType) -> List[List[str]]:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä Gemini.

        Args:
            connector (BaseConnector): –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –¥–ª—è aiohttp.
            media (MediaListType): –°–ø–∏—Å–æ–∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.

        Returns:
            List[List[str]]: –°–ø–∏—Å–æ–∫ URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

        Raises:
            Exception: –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
        """
        async def upload_image(image: bytes, image_name: str = None) -> List[str]:
            """
            –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

            Args:
                image (bytes): –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ bytes.
                image_name (str): –ò–º—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

            Returns:
                List[str]: URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏–º—è —Ñ–∞–π–ª–∞.
            """
            async with ClientSession(
                headers=UPLOAD_IMAGE_HEADERS,
                connector=connector
            ) as session:
                image = to_bytes(image)

                async with session.options(UPLOAD_IMAGE_URL) as response:
                    await raise_for_status(response)

                headers = {
                    "size": str(len(image)),
                    "x-goog-upload-command": "start"
                }
                data = f"File name: {image_name}" if image_name else None
                async with session.post(
                    UPLOAD_IMAGE_URL, headers=headers, data=data
                ) as response:
                    await raise_for_status(response)
                    upload_url = response.headers["X-Goog-Upload-Url"]

                async with session.options(upload_url, headers=headers) as response:
                    await raise_for_status(response)

                headers["x-goog-upload-command"] = "upload, finalize"
                headers["X-Goog-Upload-Offset"] = "0"
                async with session.post(
                    upload_url, headers=headers, data=image
                ) as response:
                    await raise_for_status(response)
                    return [await response.text(), image_name]
        return await asyncio.gather(*[upload_image(image, image_name) for image, image_name in media])

    @classmethod
    async def fetch_snlm0e(cls, session: ClientSession, cookies: Cookies) -> None:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ SNlM0e –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.

        Args:
            session (ClientSession): –°–µ—Å—Å–∏—è aiohttp.
            cookies (Cookies): Cookies –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.

        Raises:
            Exception: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å SNlM0e.
        """
        async with session.get(cls.url, cookies=cookies) as response:
            await raise_for_status(response)
            response_text = await response.text()
        match = re.search(r'SNlM0e\\":\\"(.*?)\\"', response_text)
        if match:
            cls._snlm0e = match.group(1)
        sid_match = re.search(r'"FdrFJe":"([\d-]+)"', response_text)
        if sid_match:
            cls._sid = sid_match.group(1)

class Conversation(JsonConversation):
    """
    –ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ.
    """
    def __init__(self,
        conversation_id: str,
        response_id: str,
        choice_id: str,
        model: str
    ) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç Conversation.

        Args:
            conversation_id (str): ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
            response_id (str): ID –æ—Ç–≤–µ—Ç–∞.
            choice_id (str): ID –≤—ã–±–æ—Ä–∞.
            model (str): –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å.
        """
        self.conversation_id = conversation_id
        self.response_id = response_id
        self.choice_id = choice_id
        self.model = model

async def iter_filter_base64(chunks: AsyncIterator[bytes]) -> AsyncIterator[bytes]:
    """
    –§–∏–ª—å—Ç—Ä—É–µ—Ç base64 –¥–∞–Ω–Ω—ã–µ –∏–∑ —á–∞–Ω–∫–æ–≤.

    Args:
        chunks (AsyncIterator[bytes]): –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –±–∞–π—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤.

    Yields:
        AsyncIterator[bytes]: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏.

    Raises:
        ValueError: –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ.
    """
    search_for = b'[["wrb.fr","XqA3Ic","[\\\\"\'
    end_with = b'\\\\\'
    is_started = False
    async for chunk in chunks:
        if is_started:
            if end_with in chunk:
                yield chunk.split(end_with, maxsplit=1).pop(0)
                break
            else:
                yield chunk
        elif search_for in chunk:
            is_started = True
            yield chunk.split(search_for, maxsplit=1).pop()
        else:
            raise ValueError(f"Response: {chunk}")

async def iter_base64_decode(chunks: AsyncIterator[bytes]) -> AsyncIterator[bytes]:
    """
    –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç base64 –¥–∞–Ω–Ω—ã–µ –∏–∑ —á–∞–Ω–∫–æ–≤.

    Args:
        chunks (AsyncIterator[bytes]): –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä –±–∞–π—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤.

    Yields:
        AsyncIterator[bytes]: –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏.
    """
    buffer = b""
    rest = 0
    async for chunk in chunks:
        chunk = buffer + chunk
        rest = len(chunk) % 4
        buffer = chunk[-rest:]
        yield base64.b64decode(chunk[:-rest])
    if rest > 0:
        yield base64.b64decode(buffer+rest*b"=")

async def rotate_1psidts(url: str, cookies: dict, proxy: Optional[str] = None) -> str:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç cookie "__Secure-1PSIDTS".

    Args:
        url (str): URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.
        cookies (dict): Cookies –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.
        proxy (Optional[str]): –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

    Returns:
        str: –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ cookie "__Secure-1PSIDTS".

    Raises:
        MissingAuthError: –ï—Å–ª–∏ cookies –Ω–µ–≤–∞–ª–∏–¥–Ω—ã.
        Exception: –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
    """
    path = Path(get_cookies_dir())
    path.mkdir(parents=True, exist_ok=True)
    filename = f"auth_Gemini.json"
    path = path / filename

    # Check if the cache file was modified in the last minute to avoid 429 Too Many Requests
    if not (path.is_file() and time.time() - os.path.getmtime(path) <= 60):
        async with ClientSession(proxy=proxy) as client:
            response = await client.post(
                url=ROTATE_COOKIES_URL,
                headers={
                    "Content-Type": "application/json",
                },
                cookies=cookies,
                data='[000,"-0000000000000000000"]',
            )
            if response.status == 401:
                raise MissingAuthError("Invalid cookies")
            response.raise_for_status()
            for key, c in response.cookies.items():
                cookies[key] = c.value
            new_1psidts = response.cookies.get("__Secure-1PSIDTS")
            path.write_text(json.dumps([
                {"name": k, "value": v, "domain": GOOGLE_COOKIE_DOMAIN} for k, v in cookies.items()
            ]))
            if new_1psidts:
                return new_1psidts