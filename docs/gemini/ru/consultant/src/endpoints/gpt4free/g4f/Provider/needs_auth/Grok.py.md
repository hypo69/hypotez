### **–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `Grok.py`**

#### **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**:
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π `async` –∏ `await` –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
  - –ö–ª–∞—Å—Å—ã `Grok` –∏ `Conversation` —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø–æ–Ω—è—Ç–Ω—ã.
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `StreamSession` –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö.
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `raise_for_status`.
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∫—É–∫–∞–º–∏ –∏ –ø—Ä–æ–∫—Å–∏.
- **–ú–∏–Ω—É—Å—ã**:
  - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–ª–∞—Å—Å–æ–≤.
  - –ù–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ç–∏–ø–∞–º–∏.
  - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏.
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `cookies` –∏ `headers` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `ImagePreview` –∏ `ImageResponse`.
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `os.environ.get("G4F_LOGIN_URL")` –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.
  - –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.

#### **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é**:
1. **–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**:
   - –î–æ–±–∞–≤–∏—Ç—å docstring –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–ª–∞—Å—Å–æ–≤, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.

2. **–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤**:
   - –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ö–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –¥–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏.

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `G4F_LOGIN_URL` –∏ –≤—ã–≤–æ–¥–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.

5. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**:
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `logger.error` —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ (`ex`) –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (`exc_info=True`).

6. **–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**:
   - –ò–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `cookies` –∏ `headers` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `ImagePreview` –∏ `ImageResponse`, –≤–æ–∑–º–æ–∂–Ω–æ, –ø–µ—Ä–µ–¥–∞–≤–∞—è –∏—Ö —á–µ—Ä–µ–∑ `auth_result`.

7. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**:
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞, —Ç–∞–∫–∏—Ö –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `json_data` –≤ —Ü–∏–∫–ª–µ `async for line in response.iter_lines()`.

8. **–£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PEP8.

#### **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥**:
```python
from __future__ import annotations

import os
import json
import time
from typing import Dict, Any, AsyncIterator, Optional, List
from pathlib import Path

from ...typing import Messages, Cookies, AsyncResult
from ...providers.response import JsonConversation, Reasoning, ImagePreview, ImageResponse, TitleGeneration, AuthResult, RequestLogin
from ...requests import StreamSession, get_args_from_nodriver, DEFAULT_HEADERS
from ...requests.raise_for_status import raise_for_status
from ..base_provider import AsyncAuthedProvider, ProviderModelMixin
from ..helper import format_prompt, get_cookies, get_last_user_message
from src.logger import logger  # Import logger module

class Conversation(JsonConversation):
    """
    –ö–ª–∞—Å—Å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å Grok.

    Args:
        conversation_id (str): –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
    """
    def __init__(self, conversation_id: str) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç Conversation.

        Args:
            conversation_id (str): –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
        """
        self.conversation_id = conversation_id

class Grok(AsyncAuthedProvider, ProviderModelMixin):
    """
    –ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Grok AI.
    """
    label: str = "Grok AI"
    url: str = "https://grok.com"
    cookie_domain: str = ".grok.com"
    assets_url: str = "https://assets.grok.com"
    conversation_url: str = "https://grok.com/rest/app-chat/conversations"

    needs_auth: bool = True
    working: bool = True

    default_model: str = "grok-3"
    models: List[str] = [default_model, "grok-3-thinking", "grok-2"]
    model_aliases: Dict[str, str] = {"grok-3-r1": "grok-3-thinking"}

    @classmethod
    async def on_auth_async(cls, cookies: Optional[Cookies] = None, proxy: Optional[str] = None, **kwargs) -> AsyncIterator:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

        Args:
            cookies (Optional[Cookies], optional): –ö—É–∫–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            proxy (Optional[str], optional): –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.

        Yields:
            AuthResult: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
            RequestLogin: –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
        """
        if cookies is None:
            cookies = get_cookies(cls.cookie_domain, False, True, False)
        if cookies is not None and "sso" in cookies:
            yield AuthResult(
                cookies=cookies,
                impersonate="chrome",
                proxy=proxy,
                headers=DEFAULT_HEADERS
            )
            return
        login_url = os.environ.get("G4F_LOGIN_URL")
        if not login_url:
            logger.warning("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è G4F_LOGIN_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")  # Log warning if G4F_LOGIN_URL is not set
            login_url = ""
        yield RequestLogin(cls.__name__, login_url)
        yield AuthResult(
            **await get_args_from_nodriver(
                cls.url,
                proxy=proxy,
                wait_for='[href="/chat#private"]'
            )
        )

    @classmethod
    async def _prepare_payload(cls, model: str, message: str) -> Dict[str, Any]:
        """
        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç payload –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Grok AI.

        Args:
            model (str): –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å.
            message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.

        Returns:
            Dict[str, Any]: –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π payload.
        """
        return {
            "temporary": False,
            "modelName": "grok-latest" if model == "grok-2" else "grok-3",
            "message": message,
            "fileAttachments": [],
            "imageAttachments": [],
            "disableSearch": False,
            "enableImageGeneration": True,
            "returnImageBytes": False,
            "returnRawGrokInXaiRequest": False,
            "enableImageStreaming": True,
            "imageGenerationCount": 2,
            "forceConcise": False,
            "toolOverrides": {},
            "enableSideBySide": True,
            "isPreset": False,
            "sendFinalMetadata": True,
            "customInstructions": "",
            "deepsearchPreset": "",
            "isReasoning": model.endswith("-thinking") or model.endswith("-r1"),
        }

    @classmethod
    async def create_authed(
        cls,
        model: str,
        messages: Messages,
        auth_result: AuthResult,
        cookies: Optional[Cookies] = None,
        return_conversation: bool = False,
        conversation: Optional[Conversation] = None,
        **kwargs
    ) -> AsyncResult:
        """
        –°–æ–∑–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Grok AI.

        Args:
            model (str): –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å.
            messages (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
            auth_result (AuthResult): –†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
            cookies (Optional[Cookies], optional): –ö—É–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            return_conversation (bool, optional): –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ª–∏ –æ–±—ä–µ–∫—Ç Conversation. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é False.
            conversation (Optional[Conversation], optional): –û–±—ä–µ–∫—Ç Conversation –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.

        Yields:
            AsyncResult: –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞.
        """
        conversation_id = None if conversation is None else conversation.conversation_id
        prompt = format_prompt(messages) if conversation_id is None else get_last_user_message(messages)
        auth_dict = auth_result.get_dict()
        async with StreamSession(**auth_dict) as session:
            payload = await cls._prepare_payload(model, prompt)
            if conversation_id is None:
                url = f"{cls.conversation_url}/new"
            else:
                url = f"{cls.conversation_url}/{conversation_id}/responses"
            try:
                async with session.post(url, json=payload) as response:
                    await raise_for_status(response)

                    thinking_duration = None
                    async for line in response.iter_lines():
                        if line:
                            try:
                                json_data = json.loads(line)
                                result = json_data.get("result", {})
                                if conversation_id is None:
                                    conversation_id = result.get("conversation", {}).get("conversationId")
                                response_data = result.get("response", {})
                                image = response_data.get("streamingImageGenerationResponse", None)
                                if image is not None:
                                    yield ImagePreview(f'{cls.assets_url}/{image["imageUrl"]}', "", auth_dict)  # Pass auth_dict instead of cookies and headers
                                token = response_data.get("token", result.get("token"))
                                is_thinking = response_data.get("isThinking", result.get("isThinking"))
                                if token:
                                    if is_thinking:
                                        if thinking_duration is None:
                                            thinking_duration = time.time()
                                            yield Reasoning(status="ü§î Is thinking...")
                                        yield Reasoning(token)
                                    else:
                                        if thinking_duration is not None:
                                            thinking_duration = time.time() - thinking_duration
                                            status = f"Thought for {thinking_duration:.2f}s" if thinking_duration > 1 else "Finished"
                                            thinking_duration = None
                                            yield Reasoning(status=status)
                                        yield token
                                generated_images = response_data.get("modelResponse", {}).get("generatedImageUrls", None)
                                if generated_images:
                                    yield ImageResponse([f'{cls.assets_url}/{image}\' for image in generated_images], "", auth_dict)  # Pass auth_dict instead of cookies and headers
                                title = result.get("title", {}).get("newTitle", "")
                                if title:
                                    yield TitleGeneration(title)

                            except json.JSONDecodeError as ex:
                                logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ JSON", ex, exc_info=True)  # Log JSONDecodeError

                    if return_conversation and conversation_id is not None:
                        yield Conversation(conversation_id)
            except Exception as ex:
                logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞", ex, exc_info=True)  # Log other exceptions