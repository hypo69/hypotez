# Документация: Локаторы полей на HTML-странице

## Обзор

Этот документ описывает структуру и использование локаторов для поиска элементов на HTML-странице в проекте `hypotez`. Локаторы используются для определения полей данных, необходимых для извлечения информации о продуктах.

## Подробней

В проекте `hypotez` для работы с веб-страницами и извлечения данных используются локаторы. Локаторы представляют собой JSON-объекты, содержащие инструкции по поиску определённых элементов на странице и взаимодействию с ними.

## Пример локатора

```json
"close_banner": {
    "attribute": null,
    "by": "XPATH",
    "selector": "//button[@id = 'closeXButton']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "click()",
    "locator_description": "Закрываю pop-up окно, если оно не появилось - не страшно (`mandatory`: `false`)."
  },
  "additional_images_urls": {
    "attribute": "src",
    "by": "XPATH",
    "selector": "//ol[contains(@class, \'flex-control-thumbs\')]//img",
    "if_list": "all",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": null,
    "locator_description": "Получить список `url` дополнительных изображений."
  },
  "id_supplier": {
    "attribute": "innerText",
    "by": "XPATH",
    "selector": "//span[@class = \'ltr sku-copy\']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": true,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": null,
    "locator_description": "SKU Morlevi."
  },
  "default_image_url": {
    "attribute": null,
    "by": "XPATH",
    "selector": "//a[@id = \'mainpic\']//img",
    "if_list": "first",
    "use_mouse": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "screenshot()",
    "mandatory": true,
    "locator_description": "Внимание! В Morlevi изображение получается через screenshot и возвращается в виде PNG (`bytes`)."
  }
```

## Описание полей

Имя словаря соответствует имени поля в классе `ProductFields` (подробнее о [`ProductFields`](../product/product_fields)).

*   **`attribute`**: Атрибут, который нужно получить из веб-элемента. Примеры: `innerText`, `src`, `id`, `href` и т.д. Если `attribute` имеет значение `none/false`, WebDriver вернет весь веб-элемент (`WebElement`).
*   **`by`**: Стратегия поиска элемента:
    *   `ID` соответствует `By.ID`
    *   `NAME` соответствует `By.NAME`
    *   `CLASS_NAME` соответствует `By.CLASS_NAME`
    *   `TAG_NAME` соответствует `By.TAG_NAME`
    *   `LINK_TEXT` соответствует `By.LINK_TEXT`
    *   `PARTIAL_LINK_TEXT` соответствует `By.PARTIAL_LINK_TEXT`
    *   `CSS_SELECTOR` соответствует `By.CSS_SELECTOR`
    *   `XPATH` соответствует `By.XPATH`
*   **`selector`**: Селектор, определяющий способ поиска веб-элемента. Примеры: `(//li[@class = \'slide selected previous\'])[1]//img`, `//a[@id = \'mainpic\']//img`, `//span[@class = \'ltr sku-copy\']`.
*   **`if_list`**: Указывает, что делать со списком найденных веб-элементов (`web_element`). Возможные значения:
    *   `first`: вернуть первый элемент из списка.
    *   `all`: вернуть все элементы.
    *   `last`: вернуть последний элемент.
    *   `even`, `odd`: вернуть четные/нечетные элементы.
    *   Конкретные числа, например, `1,2,...` или `[1,3,5]`: вернуть элементы с указанными номерами.
    Альтернативно, можно указать номер элемента непосредственно в селекторе, например: `(//div[contains(@class, \'description\')])[2]//p`.
*   **`use_mouse`**: `true` | `false`. Определяет, следует ли использовать мышь для взаимодействия с элементом.
*   **`event`**: WebDriver может выполнить действие над веб-элементом, такое как `click()`, `screenshot()`, `scroll()` и т.д. **Важно**: Если указано `event`, оно будет выполнено **до** получения значения из `attribute`.
    Пример:

    ```json
    {
        ...
        "attribute": "href",
        ...
        "timeout": 0,
        "timeout_for_event": "presence_of_element_located",
        "event": "click()",
        ...
    }
    ```

    В этом случае драйвер сначала выполнит `click()` на веб-элементе, а затем получит его атрибут `href`. Последовательность работает как: **действие -> атрибут**.

    Другие примеры событий:
    *   `screenshot()` возвращает веб-элемент в виде скриншота. Полезно, когда `CDN` сервер не возвращает изображение через `URL`.
    *   `send_message()` отправляет сообщение веб-элементу. Рекомендуется отправлять сообщение через переменную `%EXTERNAL_MESSAGE%`, как показано ниже:
        *   `{"timeout": 0, "timeout_for_event": "presence_of_element_located", "event": "click();backspace(10);%EXTERNAL_MESSAGE%"}`
            Это выполнит следующую последовательность:

            1.  `click()` - щелкает веб-элемент (фокусируется на поле ввода) `<textbox>`.
            2.  `backspace(10)` - перемещает курсор на 10 символов влево (очищает текст в поле ввода).
            3.  `%EXTERNAL_MESSAGE%` - отправляет сообщение в поле ввода.
*   **`mandatory`**: Указывает, является ли локатор обязательным. Если `{mandatory: true}` и взаимодействие с элементом невозможно, будет выдана ошибка. Если `mandatory: false`, элемент будет пропущен.
*   **`locator_description`**: Описание локатора.
*   **`timeout`**: Время ожидания (в секундах) для поиска элемента. Значение `0` означает отсутствие ожидания; элемент будет найден немедленно.
*   **`timeout_for_event`**: Время ожидания (в секундах) для события. `"presence_of_element_located"` означает, что WebDriver будет ждать, пока элемент не появится, прежде чем выполнять событие.

## Сложные локаторы

В ключах локатора можно передавать списки, кортежи или словари.

### Пример локатора со списками

```json
"sample_locator": {
    "attribute": [
      null,
      "href"
    ],
    "by": [
      "XPATH",
      "XPATH"
    ],
    "selector": [
      "//a[contains(@href, '#tab-description')]",
      "//div[@id = 'tab-description']//p"
    ],
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": [
      "click()",
      null
    ],
    "if_list": "first",
    "use_mouse": [
      false,
      false
    ],
    "mandatory": [
      true,
      true
    ],
    "locator_description": [
      "Клик по вкладке, чтобы открыть поле описания.",
      "Чтение данных из div."
    ]
  }
```

В этом примере будет найден первый элемент `//a[contains(@href, \'#tab-description\')]`. Драйвер выполнит `click()` и затем получит атрибут `href` элемента `//a[contains(@href, \'#tab-description\')]`.

### Пример локатора со словарем

```json
"sample_locator": {
  "attribute": {"href": "name"},
  ...
}
```

## Описания ключей для локаторов

1.  **`attribute`**: Этот ключ указывает атрибут, который будет использоваться для получения данных из элемента. `null` означает, что атрибут не используется для поиска элемента.

2.  **`by`**: Определяет метод для определения местоположения элемента на странице. В данном случае это `'XPATH'`, что означает использование XPath для определения местоположения элемента.

3.  **`selector`**: Строка локатора, которая будет использоваться для поиска веб-элемента. В данном случае это выражение XPath `"//a[@id = \'mainpic\']//img"`, которое находит изображение внутри тега `a` с `id=\'mainpic\'`.

4.  **`if_list`**: Указывает правило для обработки списка элементов. В данном случае `'first'` означает возврат первого элемента из списка.

5.  **`use_mouse`**: Логическое значение, указывающее, следует ли использовать мышь для взаимодействия с элементом. Установлено значение `false`, что означает, что взаимодействие с мышью не требуется.

6.  **`timeout`**: Время ожидания (в секундах) для поиска элемента. Значение `0` означает отсутствие ожидания; элемент будет найден немедленно.

7.  **`timeout_for_event`**: Время ожидания (в секундах) для события. `"presence_of_element_located"` означает, что WebDriver будет ждать, пока элемент не появится, прежде чем выполнять событие.

8.  **`event`**: Действие, которое будет выполнено над веб-элементом, например `click()`, `screenshot()`, `scroll()` и т. д. Событие будет выполнено до получения значения из `attribute`.

9.  **`mandatory`**: Указывает, является ли локатор обязательным. Если установлено значение `true`, будет выдана ошибка, если элемент не может быть найден или с ним невозможно взаимодействовать.

10. **`locator_description`**: Описание локатора, предоставляющее дополнительный контекст о том, что он делает.

## Дополнительные рекомендации

Макет страницы может отличаться, например, между настольной и мобильной версиями. В таких случаях рекомендуется хранить отдельные файлы локаторов для каждой версии.
Пример: `product.json`, `product_mobile_site.json`.