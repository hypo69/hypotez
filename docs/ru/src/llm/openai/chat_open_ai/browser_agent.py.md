# Модуль для быстрого запуска ИИ-агента для поиска информации в Google и анализа веб-страниц

## Обзор

Модуль `src.ai.openai.chat_openai.browser_agent` предназначен для быстрой настройки и запуска ИИ-агента, который может искать информацию в Google и анализировать веб-страницы. В модуле используется библиотека `browser_use` для управления браузером и `langchain_openai` для взаимодействия с языковой моделью OpenAI.

## Подробнее

Этот модуль позволяет автоматизировать задачи поиска и анализа информации в интернете с использованием ИИ. Он предоставляет класс `AIBrowserAgent`, который упрощает создание и настройку агента для выполнения различных задач, таких как поиск аналогов продуктов или ответы на вопросы с использованием поиска в интернете.

## Классы

### `AIBrowserAgent`

**Описание**: Класс для создания агента, использующего браузер для выполнения задач.

**Атрибуты**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `llm` (ChatOpenAI): Инстанс языковой модели OpenAI.
- `custom_driver` (Optional[object]): Опциональный инстанс WebDriver.

**Методы**:
- `__init__`: Инициализирует класс `AIBrowserAgent`.
- `run_task`: Запускает агента для выполнения заданной задачи.
- `find_product_alternatives`: Ищет в сети аналоги для продукта по заданному URL или SKU.
- `ask`: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию.
- `ask_async`: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

#### `__init__`
```python
def __init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None) -> None:
```
**Назначение**: Инициализирует класс `AIBrowserAgent`.

**Параметры**:
- `api_key` (str): Ключ API OpenAI (необязательный). Если не указан, будет использован ключ из переменных окружения.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `custom_driver` (Optional[object], optional): Опционально внедренный экземпляр WebDriver, по умолчанию `None` (используется значение по умолчанию `browser_use`).

**Как работает функция**:

- Функция инициализирует атрибуты класса `AIBrowserAgent` с переданными значениями.
- Создается инстанс языковой модели OpenAI (`ChatOpenAI`) с использованием указанного `model_name` и `api_key`.
- Сохраняется переданный инстанс WebDriver в атрибуте `custom_driver`.

**Примеры**:

```python
agent = AIBrowserAgent(api_key="your_api_key", model_name="gpt-4o-mini", search_engine="google")
```

#### `run_task`
```python
async def run_task(self, task_prompt: str) -> Optional[str]:
```
**Назначение**: Запускает агента для выполнения заданной задачи.

**Параметры**:
- `task_prompt` (str): Текст задачи для агента.

**Возвращает**:
- `Optional[str]`: Результат выполнения задачи в виде строки, или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если во время выполнения задачи возникает ошибка.

**Как работает функция**:

- Функция принимает текстовое описание задачи (`task_prompt`) и пытается выполнить ее с помощью агента.
- Логируется начало выполнения задачи.
- Создается инстанс агента `Agent` из библиотеки `browser_use` с переданными параметрами, включая языковую модель и драйвер браузера.
- Вызывается метод `run()` агента для выполнения задачи.
- Логируется завершение выполнения задачи.
- Пытается закрыть драйвер браузера, если это возможно.
- В случае возникновения ошибки, информация об ошибке логируется.

**Примеры**:

```python
task_prompt = "Найди информацию о последних новостях в мире."
result = await agent.run_task(task_prompt)
if result:
    print(result)
else:
    print("Не удалось выполнить задачу.")
```

#### `find_product_alternatives`
```python
async def find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]:
```
**Назначение**: Ищет в сети аналоги для продукта по заданному URL или SKU.

**Параметры**:
- `product_url` (Optional[str], optional): URL продукта, для которого нужно найти аналоги (опционально). По умолчанию `None`.
- `sku` (Optional[str], optional): SKU продукта, для которого нужно найти аналоги (опционально). По умолчанию `None`.

**Возвращает**:
- `Optional[str]`: Строку с описанием найденных аналогов, или `None` в случае ошибки или если не указан ни `product_url`, ни `sku`.

**Как работает функция**:

- Функция принимает URL продукта или SKU продукта, для которого нужно найти аналоги.
- Формируется поисковый запрос в зависимости от того, что было передано: URL или SKU.
- Если не указан ни URL, ни SKU, логируется предупреждение и возвращается `None`.
- URL-кодируется поисковый запрос.
- Формируется URL для поисковой системы (Google или DuckDuckGo в зависимости от значения `self.search_engine`).
- Формируется текстовое описание задачи (`task_prompt`) для агента, включающее URL поисковой системы и инструкцию по поиску аналогов продукта.
- Вызывается метод `run_task` для выполнения задачи.

**Примеры**:

```python
alternatives = await agent.find_product_alternatives(product_url="https://www.example.com/product")
if alternatives:
    print(alternatives)
else:
    print("Не удалось найти аналоги.")
```

```python
alternatives = await agent.find_product_alternatives(sku="12345")
if alternatives:
    print(alternatives)
else:
    print("Не удалось найти аналоги.")
```

#### `ask`
```python
def ask(self, q: str) -> Optional[str]:
```
**Назначение**: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:

- Функция принимает вопрос `q` и формирует текстовое описание задачи (`task_prompt`) для агента, включающее вопрос и инструкцию по использованию поиска в интернете, если это необходимо.
- Вызывается метод `run_task` для выполнения задачи.

**Примеры**:

```python
answer = agent.ask("Какая сейчас погода в Москве?")
if answer:
    print(answer)
else:
    print("Не удалось получить ответ на вопрос.")
```

#### `ask_async`
```python
async def ask_async(self, q: str) -> Optional[str]:
```
**Назначение**: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:

- Функция принимает вопрос `q` и формирует текстовое описание задачи (`task_prompt`) для агента, включающее вопрос и инструкцию по использованию поиска в интернете, если это необходимо.
- Вызывается метод `run_task` для выполнения задачи.

**Примеры**:

```python
answer = await agent.ask_async("Какая сейчас погода в Москве?")
if answer:
    print(answer)
else:
    print("Не удалось получить ответ на вопрос.")
```

## Функции

### `main`
```python
async def main() -> None:
```
**Назначение**: Пример использования класса `AIBrowserAgent`.

**Как работает функция**:

- Функция создает инстанс класса `AIBrowserAgent` с указанными параметрами.
- Вызывает метод `find_product_alternatives` для поиска аналогов продукта по SKU.
- Выводит найденные аналоги или сообщение об ошибке.
- Вызывает метод `ask_async` для получения ответа на вопрос.
- Выводит ответ на вопрос или сообщение об ошибке.

**Примеры**:

```python
asyncio.run(main())