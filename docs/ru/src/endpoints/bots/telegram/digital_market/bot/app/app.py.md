# Модуль обработки эндпоинтов для Telegram бота цифрового рынка

## Обзор

Модуль содержит функции для обработки входящих запросов, таких как вебхуки от Telegram, ответы от Робокассы об успешной или неуспешной оплате, а также для отображения главной страницы сервиса.

## Подробней

Данный модуль является частью Telegram-бота для цифрового рынка и отвечает за обработку HTTP-запросов, поступающих на различные эндпоинты. В частности, он обрабатывает вебхуки от Telegram, запросы от Робокассы, а также предоставляет функциональность для отображения главной страницы.

## Функции

### `handle_webhook`

**Назначение**: Обрабатывает входящие вебхуки от Telegram.

**Параметры**:
- `request` (web.Request): HTTP-запрос, содержащий данные вебхука.

**Возвращает**:
- `web.Response`: HTTP-ответ со статусом 200 в случае успешной обработки, либо 500 в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибки при обработке вебхука.

**Как работает функция**:
- Функция извлекает данные из запроса в формате JSON.
- Преобразует полученные данные в объект `Update` из библиотеки `aiogram`.
- Передает обновление в диспетчер `dp` для дальнейшей обработки ботом.
- Логирует ошибки в случае их возникновения.

**Примеры**:
```python
# Пример вызова (неявно вызывается при получении вебхука)
# await handle_webhook(request)
```

---

### `home_page`

**Назначение**: Обрабатывает запрос на главную страницу сервиса и отображает информацию о сервисе.

**Параметры**:
- `request` (web.Request): HTTP-запрос.

**Возвращает**:
- `web.Response`: HTTP-ответ, содержащий HTML-страницу с информацией о сервисе.

**Как работает функция**:
- Функция генерирует HTML-код страницы, содержащей приветствие и информацию о назначении сервиса.
- В HTML-коде указывается текущее время сервера.
- Функция возвращает HTTP-ответ с HTML-кодом и типом контента `text/html`.

**Примеры**:
```python
# Пример вызова (неявно вызывается при запросе на главную страницу)
# await home_page(request)
```

---

### `robokassa_result`

**Назначение**: Обрабатывает запрос от Робокассы на ResultURL, проверяет подпись и выполняет логику успешной оплаты.

**Параметры**:
- `request` (web.Request): HTTP-запрос.

**Возвращает**:
- `web.Response`: Текстовый ответ с результатами проверки.

**Как работает функция**:
1.  **Извлечение параметров из запроса**: Функция извлекает параметры из POST-запроса, такие как `SignatureValue` (подпись), `OutSum` (сумма оплаты), `InvId` (ID заказа), `Shp_user_id` (ID пользователя), `Shp_user_telegram_id` (Telegram ID пользователя) и `Shp_product_id` (ID продукта).
2.  **Проверка подписи**: Используется функция `check_signature_result` для проверки подписи, переданной от Робокассы. Подпись проверяется с использованием секретного ключа `settings.MRH_PASS_2` и других параметров запроса.
3.  **Обработка успешной проверки**: Если подпись верна, функция формирует ответ `OK{inv_id}` и выполняет следующие действия:
    *   Логирует успешную проверку подписи.
    *   Формирует словарь `payment_data` с информацией о платеже.
    *   Вызывает функцию `successful_payment_logic` для обработки успешного платежа (например, начисление средств пользователю, обновление статуса заказа).
    *   Фиксирует изменения в базе данных.
4.  **Обработка неверной подписи**: Если подпись неверна, функция формирует ответ `"bad sign"` и логирует предупреждение о неверной подписи.
5.  **Возврат ответа**: Функция возвращает HTTP-ответ с текстом результата проверки.

**Внутренние функции**:

*   В данной функции нет внутренних функций.

**Примеры**:
```python
# Пример вызова (неявно вызывается при получении уведомления от Робокассы)
# await robokassa_result(request)
```

---

### `robokassa_fail`

**Назначение**: Обрабатывает запрос при неудачном платеже через Робокассу.

**Параметры**:
- `request` (web.Request): HTTP-запрос.

**Возвращает**:
- `web.Response`: HTTP-ответ с сообщением о неудачном платеже.

**Как работает функция**:
- Функция извлекает параметры `InvId` (ID заказа) и `OutSum` (сумма оплаты) из GET-запроса.
- Выводит информацию о неудачном платеже в консоль.
- Возвращает HTTP-ответ с текстом "Платеж не удался" и типом контента `text/html`.

**Внутренние функции**:

*   В данной функции нет внутренних функций.

**Примеры**:
```python
# Пример вызова (неявно вызывается при получении уведомления о неудачном платеже от Робокассы)
# await robokassa_fail(request)