# Модуль dao.py

## Обзор

Модуль `dao.py` содержит классы для доступа к данным (DAO) для работы с моделями базы данных, такими как `User`, `Purchase`, `Category` и `Product`. Он предоставляет методы для выполнения операций CRUD (создание, чтение, обновление, удаление) и получения статистической информации из базы данных.

## Подробнее

Модуль содержит DAO классы для каждой модели базы данных. Каждый DAO класс наследуется от базового класса `BaseDAO` и предоставляет методы для выполнения операций с соответствующей моделью. Модуль также содержит методы для получения статистической информации, такой как общее число покупок, общая сумма покупок, статистика пользователей и статистика платежей.

## Классы

### `UserDAO`

**Описание**: Класс для доступа к данным модели `User`. Предоставляет методы для получения статистики покупок пользователя и информации о приобретенных товарах.

**Наследует**: `BaseDAO[User]`

**Методы**:

- `get_purchase_statistics`: Получает статистику покупок пользователя.
- `get_purchased_products`: Получает информацию о приобретенных пользователем товарах.
- `get_statistics`: Получает общую статистику пользователей.

### `PurchaseDao`

**Описание**: Класс для доступа к данным модели `Purchase`. Предоставляет методы для получения статистики платежей и общей суммы покупок.

**Наследует**: `BaseDAO[Purchase]`

**Методы**:

- `get_payment_stats`: Получает статистику платежей.
- `get_full_summ`: Получает общую сумму покупок.
- `get_next_id`: Получает следующий свободный ID для новой записи.

### `CategoryDao`

**Описание**: Класс для доступа к данным модели `Category`.

**Наследует**: `BaseDAO[Category]`

### `ProductDao`

**Описание**: Класс для доступа к данным модели `Product`.

**Наследует**: `BaseDAO[Product]`

## Методы класса

### `UserDAO`

#### `get_purchase_statistics`

```python
@classmethod
async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
    """
    Функция получает статистику покупок пользователя, включая общее количество покупок и общую сумму покупок.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Идентификатор Telegram пользователя.

    Returns:
        Optional[Dict[str, int]]: Словарь со статистикой покупок, содержащий ключи 'total_purchases' (общее количество покупок) и 'total_amount' (общая сумма покупок).
        Возвращает None в случае ошибки или отсутствия данных.
    
    Raises:
        SQLAlchemyError: Если возникает ошибка при работе с базой данных.

    
    - Выполняет запрос к базе данных для получения общего числа покупок и общей суммы покупок для заданного пользователя.
    - Обрабатывает результат запроса и возвращает словарь со статистикой.
    - В случае ошибки логирует ошибку и возвращает None.

    Пример:
        >>> session = AsyncSession()
        >>> telegram_id = 123456789
        >>> stats = await UserDAO.get_purchase_statistics(session, telegram_id)
        >>> if stats:
        ...     print(f"Общее число покупок: {stats['total_purchases']}")
        ...     print(f"Общая сумма покупок: {stats['total_amount']}")
        ... else:
        ...     print("Статистика покупок не найдена.")
    """
    ...
```

#### `get_purchased_products`

```python
    @classmethod
    async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
        """
        Функция получает список покупок пользователя с информацией о связанных товарах.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): Идентификатор Telegram пользователя.

        Returns:
            Optional[List[Purchase]]: Список объектов Purchase, связанных с пользователем, или None, если пользователь не найден.
            Каждый объект Purchase содержит информацию о товаре, который был приобретен.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        
        - Выполняет запрос к базе данных для получения пользователя с его покупками и связанными товарами.
        - Извлекает список покупок из объекта пользователя.
        - В случае ошибки логирует ошибку и возвращает None.

        Пример:
            >>> session = AsyncSession()
            >>> telegram_id = 123456789
            >>> purchases = await UserDAO.get_purchased_products(session, telegram_id)
            >>> if purchases:
            ...     for purchase in purchases:
            ...         print(f"товар: {purchase.product.name}, Цена: {purchase.price}")
            ... else:
            ...     print("Покупки не найдены.")
        """
        ...
```

#### `get_statistics`

```python
    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        """
        Функция получает статистику пользователей, включая общее количество пользователей, количество новых пользователей за сегодня, за неделю и за месяц.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            dict: Словарь со статистикой пользователей, содержащий ключи 'total_users', 'new_today', 'new_week' и 'new_month'.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        
        - Функция извлекает текущую дату и время в формате UTC.
        - Формирует запрос к базе данных для подсчета общего количества пользователей, а также количества новых пользователей, зарегистрированных за последние 1 день, 7 дней и 30 дней.
        - Выполняет запрос и извлекает результаты.
        - Формирует словарь с результатами статистики и возвращает его.
        - В случае возникновения ошибки, она регистрируется в логе, и исключение поднимается выше.

        Пример:
            >>> session = AsyncSession()
            >>> stats = await UserDAO.get_statistics(session)
            >>> print(f"Общее количество пользователей: {stats['total_users']}")
            >>> print(f"Новых пользователей сегодня: {stats['new_today']}")
            >>> print(f"Новых пользователей за неделю: {stats['new_week']}")
            >>> print(f"Новых пользователей за месяц: {stats['new_month']}")
        """
        ...
```

### `PurchaseDao`

#### `get_payment_stats`

```python
    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """
        Функция получает статистику платежей по типам платежных систем (Юкасса, Робокасса, STARS).

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            str: Отформатированная строка со статистикой платежей для каждой платежной системы.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        
        - Выполняет запрос к базе данных для получения статистики платежей по типам платежных систем.
        - Форматирует результат запроса в строку, содержащую информацию о сумме платежей для каждой платежной системы.
        - Возвращает отформатированную строку.

        Пример:
            >>> session = AsyncSession()
            >>> stats = await PurchaseDao.get_payment_stats(session)
            >>> print(stats)
            💳 Юкасса: 1000.00 ₽
            🤖 Робокасса: 500.00 ₽
            ⭐ STARS: 100
        """
        ...
```

#### `get_full_summ`

```python
    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """
        Функция получает общую сумму всех покупок.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            int: Общая сумма всех покупок.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        
        - Выполняет запрос к базе данных для получения общей суммы всех покупок.
        - Возвращает общую сумму покупок.

        Пример:
            >>> session = AsyncSession()
            >>> total_sum = await PurchaseDao.get_full_summ(session)
            >>> print(f"Общая сумма покупок: {total_sum}")
        """
        ...
```

#### `get_next_id`

```python
    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        Функция возвращает следующий свободный ID для новой записи.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            int: Следующий свободный ID.

        
        - Выполняет запрос к базе данных для получения максимального ID в таблице.
        - Если таблица пуста, возвращает 1, иначе возвращает максимальный ID + 1.

        Пример:
            >>> session = AsyncSession()
            >>> next_id = await PurchaseDao.get_next_id(session)
            >>> print(f"Следующий свободный ID: {next_id}")
        """
        ...
```