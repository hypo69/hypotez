# Модуль `scenario`

## Обзор

Модуль `scenario` является частью проекта `hypotez` и предназначен для автоматизации процесса создания "мехирона" для Сергея Казаринова. Он включает в себя извлечение, обработку и публикацию данных о товарах из различных источников, их обработку с использованием AI и интеграцию с Facebook для публикации.

## Подробнее

Этот модуль автоматизирует процесс извлечения, анализа и публикации данных о товарах, а также создания отчетов. Он обеспечивает интеграцию с Google Gemini для обработки данных и Facebook для публикации.

## Классы

### `MexironBuilder`

**Описание**: Класс `MexironBuilder` предназначен для автоматизации процесса создания "мехирона", включая извлечение данных о товарах, их обработку и публикацию.

**Атрибуты**:

-   `driver` (Driver): Инстанс Selenium WebDriver для управления браузером.
-   `export_path` (Path): Путь для экспорта обработанных данных.
-   `mexiron_name` (Optional[str]): Пользовательское имя для процесса "мехирон".
-   `price` (Optional[str]): Цена обработки.
-   `timestamp` (datetime): Временная метка для процесса.
-   `products_list` (List[dict]): Список обработанных данных о товарах.
-   `model` (Gemini): Google Generative AI модель.
-   `config` (dict): Конфигурация, загруженная из JSON.

**Методы**:

#### `__init__(self, driver: Driver, mexiron_name: Optional[str] = None)`

**Назначение**: Инициализирует класс `MexironBuilder` с необходимыми компонентами.

**Параметры**:

-   `driver` (Driver): Инстанс Selenium WebDriver.
-   `mexiron_name` (Optional[str], optional): Пользовательское имя для процесса "мехирон". По умолчанию `None`.

#### `run_scenario(self, system_instruction: Optional[str] = None, price: Optional[str] = None, mexiron_name: Optional[str] = None, urls: Optional[str | List[str]] = None, bot: Optional[Any] = None) -> bool`

**Назначение**: Выполняет сценарий: извлекает данные о товарах, обрабатывает их через AI и сохраняет данные.

**Параметры**:

-   `system_instruction` (Optional[str], optional): Системные инструкции для AI-модели. По умолчанию `None`.
-   `price` (Optional[str], optional): Цена обработки. По умолчанию `None`.
-   `mexiron_name` (Optional[str], optional): Пользовательское имя "мехирона". По умолчанию `None`.
-   `urls` (Optional[str | List[str]], optional): URL-адреса страниц товаров. По умолчанию `None`.
-   `bot` (Optional[Any], optional): Бот для выполнения задач (например, отправки уведомлений). По умолчанию `None`.

**Возвращает**:

-   `bool`: `True`, если сценарий выполнен успешно, иначе `False`.

**Как работает функция**:

1.  **Проверка источника URL**:
    *   Если URL из OneTab, извлекает данные из OneTab.
    *   Если нет, отправляет сообщение "Попробуйте еще раз".
2.  **Проверка валидности данных**:
    *   Если данные невалидны, отправляет сообщение "Некорректные данные".
    *   Если данные валидны, запускает сценарий Mexiron.
3.  **Поиск грабера**:
    *   Если грабер найден, начинает парсинг страницы.
    *   Если грабер не найден, регистрирует сообщение об отсутствии грабера для URL.
4.  **Парсинг страницы**:
    *   Если парсинг успешен, конвертирует поля товара.
    *   Если парсинг не удался, регистрирует ошибку парсинга.
5.  **Конвертация данных**:
    *   Если конвертация успешна, сохраняет данные товара.
    *   Если конвертация не удалась, регистрирует ошибку конвертации.
6.  **Сохранение данных**:
    *   Если данные сохранены, добавляет их в список товаров.
    *   Если данные не сохранены, регистрирует ошибку сохранения.
7.  **Обработка AI**:
    *   Обрабатывает данные с помощью AI для языков `he` (иврит) и `ru` (русский).
8.  **Сохранение JSON**:
    *   Сохраняет результаты обработки в формате JSON для каждого языка.
    *   Если сохранение не удалось, регистрирует ошибку.
9.  **Генерация отчетов**:
    *   Генерирует отчеты в формате HTML и PDF для каждого языка.
    *   Если генерация отчета не удалась, регистрирует ошибку.
10. **Отправка PDF через Telegram**:
    *   Отправляет PDF-файлы через Telegram.
    *   Если отправка не удалась, регистрирует ошибку.

#### `get_graber_by_supplier_url(self, url: str) -> Graber | None`

**Назначение**: Возвращает соответствующий грабер для указанного URL поставщика.

**Параметры**:

-   `url` (str): URL-адрес страницы поставщика.

**Возвращает**:

-   `Graber | None`: Инстанс грабера, если найден, иначе `None`.

#### `convert_product_fields(self, f: ProductFields) -> dict`

**Назначение**: Преобразует поля товара в словарь.

**Параметры**:

-   `f` (ProductFields): Объект, содержащий распарсенные данные о товаре.

**Возвращает**:

-   `dict`: Форматированный словарь данных о товаре.

#### `save_product_data(self, product_data: dict) -> None`

**Назначение**: Сохраняет данные о товаре в файл.

**Параметры**:

-   `product_data` (dict): Форматированные данные о товаре.

#### `process_llm(self, products_list: List[str], lang: str, attempts: int = 3) -> tuple | bool`

**Назначение**: Обрабатывает список товаров с использованием AI-модели.

**Параметры**:

-   `products_list` (List[str]): Список словарей данных о товарах в виде строк.
-   `lang` (str): Язык обработки (`ru` или `he`).
-   `attempts` (int, optional): Количество попыток повтора в случае сбоя. По умолчанию 3.

**Возвращает**:

-   `tuple | bool`: Обработанный ответ в форматах `ru` и `he`.

#### `post_facebook(self, mexiron: SimpleNamespace) -> bool`

**Назначение**: Выполняет сценарий публикации в Facebook.

**Параметры**:

-   `mexiron` (SimpleNamespace): Обработанные данные для публикации.

**Возвращает**:

-   `bool`: `True`, если публикация успешна, иначе `False`.

#### `create_report(self, data: dict, html_file: Path, pdf_file: Path) -> None`

**Назначение**: Генерирует отчеты в формате HTML и PDF на основе обработанных данных.

**Параметры**:

-   `data` (dict): Обработанные данные.
-   `html_file` (Path): Путь для сохранения HTML-отчета.
-   `pdf_file` (Path): Путь для сохранения PDF-отчета.

## Примеры

Для использования этого скрипта выполните следующие шаги:

1.  **Инициализация драйвера**: Создайте экземпляр класса `Driver`.
2.  **Инициализация MexironBuilder**: Создайте экземпляр класса `MexironBuilder` с драйвером.
3.  **Запуск сценария**: Вызовите метод `run_scenario` с необходимыми параметрами.

```python
from src.webdriver.driver import Driver
from src.endpoints.kazarinov.scenarios.scenario_pricelist import MexironBuilder

# Инициализация драйвера
driver = Driver(...)

# Инициализация MexironBuilder
mexiron_builder = MexironBuilder(driver)

# Запуск сценария
urls = ['https://example.com/product1', 'https://example.com/product2']
mexiron_builder.run_scenario(urls=urls)
```

## Зависимости

-   `selenium`: Для автоматизации веб-браузера.
-   `asyncio`: Для асинхронных операций.
-   `pathlib`: Для обработки путей к файлам.
-   `types`: Для создания простых пространств имен.
-   `typing`: Для аннотаций типов.
-   `src.ai.gemini`: Для обработки данных с использованием AI.
-   `src.suppliers.*.graber`: Для извлечения данных из различных источников.
-   `src.endpoints.advertisement.facebook.scenarios`: Для публикации в Facebook.

## Обработка ошибок

Скрипт включает надежную обработку ошибок, чтобы обеспечить непрерывное выполнение, даже если некоторые элементы не найдены или возникли проблемы с веб-страницей. Это особенно полезно для работы с динамическими или нестабильными веб-страницами.

## Лицензия

Этот скрипт распространяется под лицензией MIT. Подробности см. в файле `LICENSE`.